<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US"><head>
<meta charset="utf-8">
<meta name="generator" content="ReSpec 32.7.1">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
span.example-title{text-transform:none}
:is(aside,div).example,div.illegal-example{padding:.5em;margin:1em 0;position:relative;clear:both}
div.illegal-example{color:red}
div.illegal-example p{color:#000}
:is(aside,div).example{border-left-width:.5em;border-left-style:solid;border-color:#e0cb52;background:#fcfaee}
aside.example div.example{border-left-width:.1em;border-color:#999;background:#fff}
.example pre{background-color:rgba(0,0,0,.03)}
</style>
<style>
.issue-label{text-transform:initial}
.warning>p:first-child{margin-top:0}
.warning{padding:.5em;border-left-width:.5em;border-left-style:solid}
span.warning{padding:.1em .5em .15em}
.issue.closed span.issue-number{text-decoration:line-through}
.issue.closed span.issue-number::after{content:" (Closed)";font-size:smaller}
.warning{border-color:#f11;border-width:.2em;border-style:solid;background:#fbe9e9}
.warning-title:before{content:"⚠";font-size:1.3em;float:left;padding-right:.3em;margin-top:-.3em}
li.task-list-item{list-style:none}
input.task-list-item-checkbox{margin:0 .35em .25em -1.6em;vertical-align:middle}
.issue a.respec-gh-label{padding:5px;margin:0 2px 0 2px;font-size:10px;text-transform:none;text-decoration:none;font-weight:700;border-radius:4px;position:relative;bottom:2px;border:none;display:inline-block}
</style>
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;color:#000;box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;margin-top:.25em}
.dfn-panel ul a[href]{color:#333}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
		
		
<title>Federated Learning API</title>
		
		
		
	
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
:is(h1,h2,h3,h4,h5,h6,a) abbr{border:none}
dfn{font-weight:700}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
.toc a,.tof a{text-decoration:none}
a .figno,a .secno{color:#000}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
table.simple{border-spacing:0;border-collapse:collapse;border-bottom:3px solid #005a9c}
.simple th{background:#005a9c;color:#fff;padding:3px 5px;text-align:left}
.simple th a{color:#fff;padding:3px 5px;text-align:left}
.simple th[scope=row]{background:inherit;color:inherit;border-top:1px solid #ddd}
.simple td{padding:3px 10px;border-top:1px solid #ddd}
.simple tr:nth-child(even){background:#f0f6ff}
.section dd>p:first-child{margin-top:0}
.section dd>p:last-child{margin-bottom:0}
.section dd{margin-bottom:1em}
.section dl.attrs dd,.section dl.eldef dd{margin-bottom:0}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"§";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
<style>

/****************************************************/
/*  property tables                                 */
/****************************************************/

/* ensure confomity of width for property tables */
table.tabledef {
	border-spacing: 0px;
	border: none;
	font-size: 1em;
	width: 100%
}

table.tabledef td, table.tabledef th {
	border: none;
	background-color: rgb(236,246,255);
	color: rgb(0,0,0);
	padding: 0.3em;
	vertical-align: top;
}

table.tabledef th {
    text-align: left;
	vertical-align: top;
    width: 8em;
    padding-left: 1em;
}

table.tabledef th {
    border-left: 5px solid rgb(145,200,255);
}

table.tabledef td {
    padding: 3px 3px 3px 10px;
}

table.tabledef td > p:first-child {
	padding: 0em;
	margin: 0em
}

a code
{
    color: rgb(3,69,117) !important;
}

</style>
<meta name="description" content="This proposal defines interfaces that enables the implementation and management of federated learning systems.">
<link rel="canonical" href="https://w3c.github.io/federated-learning-cg/reports/index.html">
<style>
.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}
.hljs-comment,.hljs-quote{color:#717277;font-style:italic}
.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}
.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#ca4706;font-weight:700}
.hljs-literal{color:#0b76c5}
.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#42803c}
.hljs-built_in,.hljs-class .hljs-title{color:#9a6a01}
.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}
.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#336ae3}
.hljs-emphasis{font-style:italic}
.hljs-strong{font-weight:700}
.hljs-link{text-decoration:underline}
</style>
<style>
var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#000}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#000;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}
</style>
<script id="initialUserConfig" type="application/json">{
  "group": "federated-learning",
  "edDraftURI": "https://w3c.github.io/federated-learning-cg/reports/index.html",
  "latestVersion": "https://w3c.github.io/federated-learning-cg/reports/index.html",
  "specStatus": "CG-DRAFT",
  "shortName": "fl-api",
  "noRecTrack": true,
  "copyrightStart": "2022",
  "editors": [
    {
      "name": "신성필(Sungpil Shin)",
      "company": "한국전자통신연구원(ETRI)",
      "url": "mailto:spshin@etri.re.kr",
      "companyURL": "https://etri.re.kr/eng/main/main.etri",
      "w3cid": 117861
    },
    {
      "name": "이원석(Wonsuk Lee)",
      "company": "한국전자통신연구원(ETRI)",
      "url": "mailto:wonsuk.lee@etri.re.kr",
      "companyURL": "https://etri.re.kr/eng/main/main.etri",
      "w3cid": 34457
    }    
  ],
  "processVersion": 2020,
  "includePermalinks": true,
  "permalinkEdge": true,
  "permalinkHide": false,
  "github": {
    "repoURL": "https://github.com/w3c/federated-learning-cg",
    "branch": "master"
  },
  "preProcess": [
    null
  ],
  "localBiblio": {
    null
    /*    
    "epub-3": {
      "title": "EPUB 3",
      "href": "https://www.w3.org/TR/epub/",
      "publisher": "W3C",
      "id": "epub-3"
    }
*/    
  },
  "publishDate": "2023-09-07",
  "publishISODate": "2023-09-07T13:12:00.000Z",
  "generatedSubtitle": "Draft Community Group Report 07 September 2023"
}</script>
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/2021/cg-draft"></head>
	<body class="h-entry"><div class="head">
    
    <h1 id="title" class="title">Federated Learning API v0.1</h1> 
    <p id="w3c-state">
      <a href="https://www.w3.org/standards/types#reports">Draft Community Group Report</a>
      <time class="dt-published" datetime="2023-06-13">07 September 2023</time>
    </p>
    <dl>
      <dt>This version:</dt><dd>
              <a class="u-url" href="https://w3c.github.io/federated-learning-cg/reports/index.html">https://w3c.github.io/federated-learning-cg/reports/index.html</a>
            </dd>
      <dt>Latest published version:</dt><dd>
              <a href="https://w3c.github.io/federated-learning-cg/reports/index.html">https://w3c.github.io/federated-learning-cg/reports/index.html</a>
            </dd>
      <dt>Latest editor's draft:</dt><dd><a href="https://w3c.github.io/federated-learning-cg/reports/index.html">https://w3c.github.io/federated-learning-cg/reports/index.html</a></dd>
      
      
      
      
      <dt>Editor:</dt><dd class="editor p-author h-card vcard" data-editor-id="34457">
        <span class="p-name fn">신성필(Sungpil Shin)</span> (<a class="p-org org h-org" href="https://etri.re.kr/eng/main/main.etri">한국전자통신연구원(ETRI)</a>)<br>
        <span class="p-name fn">이원석(Wonsuk Lee)</span> (<a class="p-org org h-org" href="https://etri.re.kr/eng/main/main.etri">한국전자통신연구원(ETRI)</a>)
  </dd>
      
      
      <dt>Feedback:</dt><dd>
        <a href="https://github.com/w3c/federated-learning-cg">GitHub w3c/federated-learning-cg</a>
        (<a href="https://github.com/w3c/federated-learning-cg/pulls/">pull requests</a>,
        <a href="https://github.com/w3c/federated-learning-cg/issues/new/choose">new issue</a>,
        <a href="https://github.com/w3c/federated-learning-cg/issues/">open issues</a>)
      </dd>
    </dl>
    
    <p class="copyright">
          <a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a>
          ©
          2022-2023
          
          the Contributors to the Federated Learning API
          Specification, published by the
          <a href="https://www.w3.org/groups/cg/federated-learning">Federated Learning Community Group</a> under the
          <a href="https://www.w3.org/community/about/agreements/fsa/">W3C Community Final Specification Agreement (FSA)</a>. A human-readable
                <a href="https://www.w3.org/community/about/agreements/fsa-deed/">summary</a>
                is available.
              
        </p>
    <hr title="Separator for header">
  </div>
		<section id="abstract" class="introductory"><h2>Abstract</h2>
			<p>This proposal defines interfaces that enables the implementation and management of federated learning systems.</p>
		</section>
		<section id="sotd" class="introductory"><h2>Status of This Document</h2><p>
      This specification was published by the
      <a href="https://www.w3.org/groups/cg/federated-learning">Federated Learning Community Group</a>. It is not a W3C Standard nor is it
      on the W3C Standards Track.
      
            Please note that under the
            <a href="https://www.w3.org/community/about/agreements/final/">W3C Community Final Specification Agreement (FSA)</a>
            other conditions apply.
          
      Learn more about
      <a href="https://www.w3.org/community/">W3C Community and Business Groups</a>.
    </p><p>
    <a href="https://github.com/w3c/federated-learning-cg/issues/">GitHub Issues</a> are preferred for
          discussion of this specification.
        
    
  </p>
</section>
<nav id="toc">
  <h2 class="introductory" id="table-of-contents">Table of Contents</h2>
  <ol class="toc">
    <li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li>
    <li class="tocline"><a class="tocxref" href="#sotd">Status of This Document</a></li>
    <li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1. </bdi>Introduction</a>
      <ol class="toc">
        <li class="tocline"><a class="tocxref" href="#background"><bdi class="secno">1.1 </bdi>Background</a></li>
        <li class="tocline"><a class="tocxref" href="#sec-terminology"><bdi class="secno">1.2 </bdi>Terminology</a></li>
        <li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">1.3 </bdi>Conformance</a></li>
      </ol>
    </li>
    <li class="tocline"><a class="tocxref" href="#requirements"><bdi class="secno">2. </bdi>Requirements</a>
      <ol class="toc">
        <li class="tocline"><a class="tocxref" href="#dev-registration"><bdi class="secno">2.1 </bdi>Device Registration</a></li>
        <li class="tocline"><a class="tocxref" href="#data-upload"><bdi class="secno">2.2 </bdi>Data Upload</a></li>
        <li class="tocline"><a class="tocxref" href="#model-sync"><bdi class="secno">2.3 </bdi>Model Synchronization</a></li>
        <li class="tocline"><a class="tocxref" href="#model-evaluation"><bdi class="secno">2.4 </bdi>Model Evaluation</a></li>
        <li class="tocline"><a class="tocxref" href="#result-retrieval"><bdi class="secno">2.5 </bdi>Result Retrieval</a></li>
        <li class="tocline"><a class="tocxref" href="#training-control"><bdi class="secno">2.6 </bdi>Training Control</a></li>        
        <li class="tocline"><a class="tocxref" href="#security-privacy"><bdi class="secno">2.7 </bdi>Security and Privacy</a></li>
        <li class="tocline"><a class="tocxref" href="#extensibility-compatibility"><bdi class="secno">2.8 </bdi>Extensibility and Compatibility</a></li>        
      </ol>
    </li>

    <li class="tocline"><a class="tocxref" href="#references"><bdi class="secno">A. </bdi>References</a>
      <ol class="toc">
        <li class="tocline"><a class="tocxref" href="#normative-references"><bdi class="secno">A.1 </bdi>Normative references</a></li>
      </ol>
    </li>
  </ol>
</nav>
		<section id="introduction"><div class="header-wrapper"><h2 id="x1-introduction"><bdi class="secno">1. </bdi>Introduction</h2><a class="self-link" href="#introduction" aria-label="Permalink for Section 1."></a></div>
			

			<section id="background"><div class="header-wrapper"><h3 id="x1-1-background"><bdi class="secno">1.1 </bdi>Background</h3><a class="self-link" href="#background" aria-label="Permalink for Section 1.1"></a></div>
				

				<p>The scope of the Federated Learning API specification encompasses the development of a standardized interface that enables the implementation and management of federated learning systems. 
          It focuses on the communication and coordination between central servers and client devices participating in federated learning, with an emphasis on privacy-preserving machine learning techniques. 
          The specification covers the interactions, protocols, and data formats necessary for secure and efficient model training across decentralized devices. </p>

			</section>

			<section id="sec-terminology"><div class="header-wrapper"><h3 id="x1-2-terminology"><bdi class="secno">1.2 </bdi>Terminology</h3><a class="self-link" href="#sec-terminology" aria-label="Permalink for Section 1.2"></a></div>

				<div class="note" role="note" id="issue-container-generatedID"><div role="heading" class="note-title marker" id="h-note" aria-level="4"><span>Note</span></div><div class="">
					<p>Need to be developed.</p>
				</div></div>
			</section>

			<section id="conformance"><div class="header-wrapper"><h3 id="x1-3-conformance"><bdi class="secno">1.3 </bdi>Conformance</h3><a class="self-link" href="#conformance" aria-label="Permalink for Section 1.3"></a></div><p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p><p>
        The key word <em class="rfc2119">MUST</em> in this document
        is to be interpreted as described in
        <a href="https://datatracker.ietf.org/doc/html/bcp14">BCP 14</a>
        [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">RFC2119</a></cite>] [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8174" title="Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words">RFC8174</a></cite>]
        when, and only when, they appear in all capitals, as shown here.
      </p></section>
		</section>


    <section id="requirements"><div class="header-wrapper"><h2 id="x2-requirements"><bdi class="secno">2. </bdi>Requirements</h2><a class="self-link" href="#requirements" aria-label="Permalink for Section 2."></a></div>
      <p>The functional requirements for Federated Learning API outline the essential capabilities and specifications necessary to enable seamless communication, 
        secure data transmission, and effective coordination of federated learning systems. These requirements encompass device registration, data upload, model synchronization, 
        evaluation, result retrieval, training control, and ensuring security and privacy measures.</p>    

			<section id="dev-registration"><div class="header-wrapper"><h3 id="x2-1-dev-registration"><bdi class="secno">2.1 </bdi>Device Registration</h3><a class="self-link" href="#dev-registration" aria-label="Permalink for Section 2.1"></a></div>
				
				<p>The API should allow devices or clients to securely register themselves with the federated learning system. 
          The API should allow devices or clients to securely register themselves with the federated learning system. 
          The API should provide endpoints for device registration, including necessary parameters and data formats.</p>

			</section>

			<section id="data-upload"><div class="header-wrapper"><h3 id="x2-2-data-upload"><bdi class="secno">2.2 </bdi>Data Upload</h3><a class="self-link" href="#data-upload" aria-label="Permalink for Section 2.2"></a></div>

				<p>The API should enable clients to securely upload their locally held data to the central server or coordinator for model training. 
          It should support various data formats and provide guidelines for data serialization and transmission. 
          The API should include endpoints for data submission, metadata specification, and possibly data encryption or anonymization.</p>

			</section>

			<section id="model-sync"><div class="header-wrapper"><h3 id="x2-3-model-sync"><bdi class="secno">2.3 </bdi>Model Synchronization</h3><a class="self-link" href="#model-sync" aria-label="Permalink for Section 2.3"></a></div>

        <p>The API should handle the communication and synchronization of model parameters between the central server and client devices.
          It should provide endpoints for retrieving the current model state, sending model updates from clients to the server, and distributing updated models back to the clients.
          The API should support efficient and secure transmission of model parameters, taking into account bandwidth limitations and data privacy requirements.</p>

			</section>

			<section id="model-evaluation"><div class="header-wrapper"><h3 id="x2-4-model-evaluation"><bdi class="secno">2.4 </bdi>Model Evaluation</h3><a class="self-link" href="#model-evaluation" aria-label="Permalink for Section 2.4"></a></div>

        <p>The API should include endpoints for clients to request model evaluation on their local data.
          It should support the transmission of evaluation requests and relevant data securely to the server.
          The API should allow clients to retrieve evaluation metrics or results from the server.</p>

			</section>      

			<section id="result-retrieval"><div class="header-wrapper"><h3 id="x2-5-result-retrieval"><bdi class="secno">2.5 </bdi>Result Retrieval</h3><a class="self-link" href="#result-retrieval" aria-label="Permalink for Section 2.4"></a></div>

        <p>The API should enable clients to retrieve the final trained model or other relevant results from the central server.
          It should provide endpoints for requesting and downloading the trained model or aggregated results.
          The API should ensure secure transmission of results and provide mechanisms for access control to protect sensitive information.</p>

			</section>

			<section id="training-control"><div class="header-wrapper"><h3 id="x2-6-training-control"><bdi class="secno">2.6 </bdi>Training Control</h3><a class="self-link" href="#training-control" aria-label="Permalink for Section 2.4"></a></div>

        <p>The API should allow for controlling the federated learning process, such as starting, pausing, or terminating model training.
          It should provide endpoints for managing training sessions, setting training parameters, and monitoring the progress of training.
          The API should support error handling and provide appropriate status codes for different training control operations.</p>

			</section>

			<section id="security-privacy"><div class="header-wrapper"><h3 id="x2-7-security-privacy"><bdi class="secno">2.7 </bdi>Security and Privacy</h3><a class="self-link" href="#security-privacy" aria-label="Permalink for Section 2.7"></a></div>

        <p>The API should incorporate security measures, such as authentication, encryption, and access control, to protect the federated learning system.
          It should ensure the privacy and confidentiality of data during transmission and storage.
          The API should adhere to privacy regulations and best practices for handling sensitive information.</p>

			</section>

			<section id="extensibility-compatibility"><div class="header-wrapper"><h3 id="x2-8-extensibility-compatibility"><bdi class="secno">2.8 </bdi>Extensibility and Compatibility</h3><a class="self-link" href="#extensibility-compatibility" aria-label="Permalink for Section 2.8"></a></div>

        <p>The API should be designed with extensibility in mind, allowing for the addition of new functionalities or endpoints in the future.
          It should be compatible with existing web standards and frameworks, facilitating integration with different software platforms and tools.</p>

			</section>
      
		</section>


<section id="references" class="appendix"><div class="header-wrapper"><h2 id="a-references"><bdi class="secno">A. </bdi>References</h2><a class="self-link" href="#references" aria-label="Permalink for Appendix A."></a></div><section id="normative-references"><div class="header-wrapper"><h3 id="a-1-normative-references"><bdi class="secno">A.1 </bdi>Normative references</h3><a class="self-link" href="#normative-references" aria-label="Permalink for Appendix A.1"></a></div>
    
    <dl class="bibliography"><dt id="bib-rfc2119">[RFC2119]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. S. Bradner.  IETF. March 1997. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>
    </dd><dt id="bib-rfc8174">[RFC8174]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc8174"><cite>Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</cite></a>. B. Leiba.  IETF. May 2017. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>
    </dd></dl>
  </section></section><p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">↑</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>
